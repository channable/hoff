---
version: "v1.0"
name: "Hoff"

agent:
  machine:
    type: "e1-standard-2"
    os_image: "ubuntu1804"

blocks:
  - name: "Build"
    task:
      jobs:
        - name: "Build, test, package"
          commands:
            - "checkout"

            # Install Nix and source the shell configuration immediately.
            - "./nix/install"
            - ". $HOME/.nix-profile/etc/profile.d/nix.sh"

            # Bring all the tools from the pinned build environment into the PATH.
            - "export PATH=$(nix-build --no-out-link default.nix)/bin:$PATH"

            # Binaries in the profile built above may need locales, that they
            # can't find unless we point LOCALE_ARCHIVE at the archive that
            # contains them.
            - "export LOCALE_ARCHIVE=$(nix-build --no-out-link locale.nix)/lib/locale/locale-archive"

            - "stack setup"
            - "stack --no-terminal build --split-objs"
            - "stack --no-terminal test --split-objs"


            # Match the licenses of dependencies agains a whitelist, and fail
            # if anything is not whitelisted. Grep -v returns # 1 if nothing
            # matches, so we invert it with a ! prefix.  The "unexceptionalio"
            # library is tagged as "license other" on Hackage, but the license
            # appears to be ISC, so whitelist it too. See also [1].
            # [1]: https://hackage.haskell.org/package/unexceptionalio-0.3.0/src/COPYING.
            - "! stack ls dependencies --license | egrep -v 'Apache-2|BSD2|BSD3|MIT|PublicDomain|MPL-2.0|unexceptionalio'"

            # Check shell scripts for issues.
            - "shellcheck package/*.sh package/deb-postinst"
